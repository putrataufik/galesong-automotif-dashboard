<div class="container-fluid p-4 no-pt">
  <!-- ================= Filter ================= -->
  <div class="row mb-2">
    <div class="col-12">
      <app-filter-main-dashboard
        [currentFilter]="currentFilter"
        [loading]="loading()"
        (search)="onSearch($event)"
      ></app-filter-main-dashboard>
    </div>
  </div>

  <!-- ============ Breadcrumb ringkas ============ -->
  <div class="row">
    <div class="col-12">
      <nav aria-label="Filter breadcrumb">
        <ol class="breadcrumb mb-0 bg-light rounded">
          <li class="breadcrumb-item">
            <i class="bi bi-funnel me-1"></i>
            Filter
          </li>
          <li class="breadcrumb-item">
            <strong>{{ getCompanyDisplayName(currentFilter.company) }}</strong>
          </li>
          <li class="breadcrumb-item">
            {{ getBranchDisplayName(currentFilter.branch) }}
          </li>
          <li class="breadcrumb-item">
            {{ getCategoryDisplayName(currentFilter.category) }}
          </li>
          <li class="breadcrumb-item" aria-current="page">
            {{ getPeriodDisplayName() }}
            @if (currentFilter.compare) { |
            <span class="breadcrumb-item active">Komparasi Data</span>
            }
          </li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- ============ KPI Section ============ -->
  @if (!loading()) { @if (kpis(); as data) {
  <div class="row g-2 mb-2">
    @if(currentFilter.category ==='sales' || currentFilter.category
    ==='all-category') {
    <div class="col-12">
      <div
        class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-2 my-3"
      >
        <div class="d-flex align-items-center">
          <i class="bi bi-speedometer2 me-2 fs-5" style="color: #2563eb"></i>
          <h6 class="mb-0 fw-bold text-dark">Sales Performance</h6>
        </div>
      </div>
    </div>

    <!-- Total SPK -->
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <app-kpi-card
        [title]="'Total SPK'"
        dataType="unit"
        [period]="data.totalSPK?.selected?.period ?? undefined"
        [value]="data.totalSPK?.selected?.value ?? 0"
        [subtitle]="currentFilter.compare ? '' : 'Surat Pemesanan Kendaraan'"
        info="Jumlah surat pemesanan kendaraan (SPK) pada periode terpilih."
        [compareMode]="compare"
        unitLabel="unit"
        [prevYearValue]="data.totalSPK?.prevYear?.value ?? null"
        [prevYearSubtitle]="data.totalSPK?.prevYear?.period ?? undefined"
        [prevMonthValue]="data.totalSPK?.prevMonth?.value ?? null"
        [prevMonthSubtitle]="data.totalSPK?.prevMonth?.period ?? undefined"
      />
    </div>

    <!-- Total DO -->
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <app-kpi-card
        [title]="'Total DO'"
        dataType="unit"
        [period]="data.totalDO?.selected?.period ?? undefined"
        [value]="data.totalDO?.selected?.value ?? 0"
        [compareMode]="compare"
        [subtitle]="currentFilter.compare ? '' : 'Delivery Order'"
        info="Jumlah unit yang telah dibuatkan Delivery Order pada periode terpilih."
        unitLabel="unit"
        [prevYearValue]="data.totalDO?.prevYear?.value ?? null"
        [prevYearSubtitle]="data.totalDO?.prevYear?.period ?? undefined"
        [prevMonthValue]="data.totalDO?.prevMonth?.value ?? null"
        [prevMonthSubtitle]="data.totalDO?.prevMonth?.period ?? undefined"
      />
    </div>
    <!-- Total Prospect  -->
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <app-kpi-card
        [title]="'Total prospek'"
        dataType="unit"
        [subtitle]="currentFilter.compare ? '' : 'Prospek Penjualan'"
        info="Jumlah unit yang telah dibuatkan Prospek Penjualan pada periode terpilih."
        [period]="data.totalProspect?.selected?.period ?? undefined"
        [value]="data.totalProspect?.selected?.value ?? 0"
        [compareMode]="compare"
        unitLabel="unit"
        [prevYearValue]="data.totalProspect?.prevYear?.value ?? null"
        [prevYearSubtitle]="data.totalProspect?.prevYear?.period ?? undefined"
        [prevMonthValue]="data.totalProspect?.prevMonth?.value ?? null"
        [prevMonthSubtitle]="data.totalProspect?.prevMonth?.period ?? undefined"
      />
    </div>
    <!-- Total Hot Prospect  -->
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <app-kpi-card
        [title]="'Total hot prospek'"
        dataType="unit"
        [subtitle]="currentFilter.compare ? '' : 'Prospek Penjualan'"
        info="Jumlah hot prospek pada periode terpilih."
        [period]="data.totalHotProspect?.selected?.period ?? undefined"
        [value]="data.totalHotProspect?.selected?.value ?? 0"
        [compareMode]="compare"
        unitLabel="unit"
        [prevYearValue]="data.totalHotProspect?.prevYear?.value ?? null"
        [prevYearSubtitle]="
          data.totalHotProspect?.prevYear?.period ?? undefined
        "
        [prevMonthValue]="data.totalHotProspect?.prevMonth?.value ?? null"
        [prevMonthSubtitle]="
          data.totalHotProspect?.prevMonth?.period ?? undefined
        "
      />
    </div>
    <!-- Model Favorit -->
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <app-kpi-card
        [title]="'Model Favorit'"
        dataType="unit"
        info="Model dengan penjualan tertinggi pada periode terpilih."
        [period]="data.topModel?.selected?.period ?? undefined"
        [value]="data.topModel?.selected?.name ?? 0"
        [subtitle]="data.topModel?.selected?.value + ' unit'"
        [compareMode]="compare"
        unitLabel="unit"
        [prevYearValue]="data.topModel?.prevYear?.name ?? null"
        [prevYearSubtitle]="data.topModel?.prevYear?.period ?? undefined"
        [prevYearName]="data.topModel?.prevYear?.value + ' unit'"
        [prevMonthValue]="data.topModel?.prevMonth?.name ?? null"
        [prevMonthSubtitle]="data.topModel?.prevMonth?.period ?? undefined"
        [prevMonthName]="data.topModel?.prevMonth?.value + ' unit'"
      />
    </div>
    <!-- Cabang Penjualan Tertinggi -->
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <app-kpi-card
        [title]="'Cabang Penjualan Tertinggi'"
        dataType="unit"
        info="Cabang dengan penjualan tertinggi pada periode terpilih."
        [period]="data.topBranch?.selected?.period ?? undefined"
        [value]="data.topBranch?.selected?.branchName ?? 0"
        [subtitle]="data.topBranch?.selected?.value + ' unit'"
        [compareMode]="compare"
        unitLabel="unit"
        [prevYearValue]="data.topBranch?.prevYear?.branchName ?? null"
        [prevYearSubtitle]="data.topBranch?.prevYear?.period ?? undefined"
        [prevYearName]="data.topBranch?.prevYear?.value + ' unit'"
        [prevMonthValue]="data.topBranch?.prevMonth?.branchName ?? null"
        [prevMonthSubtitle]="data.topBranch?.prevMonth?.period ?? undefined"
        [prevMonthName]="data.topBranch?.prevMonth?.value + ' unit'"
      />
    </div>
    <div class="row g-3 align-items-stretch">
      <!-- Trend Unit Terjual -->
      <section class="col-12 col-md-6 col-xl-4">
        @let series = trendLineSeries(); @if (trendLoading()) {
        <div
          class="card border-0 shadow-sm p-3 h-100 d-flex align-items-center justify-content-center"
        >
          Memuat tren...
        </div>
        } @else if (trendError()) {
        <div
          class="card border-0 shadow-sm p-3 h-100 d-flex align-items-center justify-content-center"
        >
          {{ trendError() }}
        </div>
        } @else if (series.length) {
        <app-line-chart-card
          class="h-100"
          [title]="'Trend Unit Terjual per Bulan'"
          [labels]="MONTH_LABELS"
          [datasets]="series"
          [showLegend]="true"
          [height]="251"
          xtitle="Bulan"
          ytitle="Unit"
        ></app-line-chart-card>
        } @else {
        <div
          class="card border-0 shadow-sm p-3 h-100 d-flex align-items-center justify-content-center"
        >
          Tidak ada data tren.
        </div>
        }
      </section>

      <!-- DO vs SPK -->
      <section class="col-12 col-md-6 col-xl-4">
        @let series2 = doSpkLineSeries(); @if (doSpkLoading()) {
        <div
          class="card border-0 shadow-sm p-3 h-100 d-flex align-items-center justify-content-center"
        >
          Memuat DO vs SPK...
        </div>
        } @else if (doSpkError()) {
        <div
          class="card border-0 shadow-sm p-3 h-100 d-flex align-items-center justify-content-center"
        >
          {{ doSpkError() }}
        </div>
        } @else if (series2.length) {
        <app-line-chart-card
          class="h-100"
          [title]="'DO vs SPK per Bulan'"
          [labels]="MONTH_LABELS"
          [datasets]="series2"
          [showLegend]="true"
          [height]="251"
          xtitle="Bulan"
          ytitle="Jumlah"
        ></app-line-chart-card>
        } @else {
        <div
          class="card border-0 shadow-sm p-3 h-100 d-flex align-items-center justify-content-center"
        >
          Tidak ada data DO vs SPK.
        </div>
        }
      </section>

      <!-- Model Distribution YoY/MoM -->
      <section class="col-12 col-xl-4">
        @let rows = modelDistRows(); @if (modelDistLoading()) {
        <div
          class="card border-0 shadow-sm p-3 h-100 d-flex align-items-center justify-content-center"
        >
          Memuat distribusi model...
        </div>
        } @else if (modelDistError()) {
        <div
          class="card border-0 shadow-sm p-3 h-100 d-flex align-items-center justify-content-center"
        >
          {{ modelDistError() }}
        </div>
        } @else if (rows.length) {
        <app-leaderboard-list-card
        [title]="'Proporsi Penjualan per Model'"
        [subtitle]="getPeriodDisplayName()"
        [unit]="'Unit'"
        [rows]="modelDistRows()"
        [maxRows]="100"
        [compare]="currentFilter.compare ?? false"
        [labelCurr]="modelLabelCurr()"
        [labelPrevY]="modelLabelPrevY()"
        [labelPrevM]="modelLabelPrevM()"
      >
      </app-leaderboard-list-card>

        } @else {
        <div
          class="card border-0 shadow-sm p-3 h-100 d-flex align-items-center justify-content-center"
        >
          Tidak ada data distribusi model.
        </div>
        }
      </section>
    </div>
    }
  </div>
  @if(currentFilter.category ==='after-sales' || currentFilter.category
  ==='all-category') {

  <div class="row g-2 mb-2">
    <div class="col-12">
      <div
        class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-2 my-3"
      >
        <div class="d-flex align-items-center">
          <i class="bi bi-speedometer2 me-2 fs-5" style="color: #006e1a"></i>
          <h6 class="mb-0 fw-bold text-dark">After Sales Performance</h6>
        </div>
      </div>
    </div>
    <!-- Jumlah Mekanik -->
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <app-kpi-card
        [title]="'Jumlah Mekanik'"
        [value]="selectedMetrics()?.mekanik ?? 0"
        [unitLabel]="'orang'"
        info="Jumlah Mekanik yang aktif pada bulan terpilih"
        [subtitle]="'Total mekanik aktif'"
        [compareMode]="currentFilter.compare || false"
        [prevYearValue]="
          prevYearBlock()?.metrics?.mekanik ??
          prevDateBlock()?.metrics?.mekanik ??
          0
        "
        [prevYearSubtitle]="
          prevYearBlock()?.period ?? prevDateBlock()?.period ?? ''
        "
        [prevMonthValue]="prevMonthBlock()?.metrics?.mekanik ?? 0"
        [prevMonthSubtitle]="prevMonthBlock()?.period ?? ''"
      />
    </div>
    <div class="col-6 col-sm-4 col-md-6 col-lg-2">
      <app-kpi-card
        [title]="'Jumlah Hari Kerja'"
        [value]="selectedMetrics()?.hari_kerja ?? 0"
        info="Jumlah hari kerja pada bulan terpilih"
        unit="hari"
        [subtitle]="compare ? '' : 'Total hari kerja'"
        icon="bi bi-calendar-check-fill"
        iconColor="#F59E0B"
        iconBgColor="#FEF3C7"
        [compareMode]="currentFilter.compare"
        [prevYearValue]="
          prevYearBlock()?.metrics?.hari_kerja ??
          prevDateBlock()?.metrics?.hari_kerja ??
          0
        "
        [prevYearSubtitle]="
          prevYearBlock()?.period ?? prevDateBlock()?.period ?? ''
        "
        [prevMonthValue]="prevMonthBlock()?.metrics?.hari_kerja ?? 0"
        [prevMonthSubtitle]="prevMonthBlock()?.period ?? ''"
      />
    </div>

    <div class="col-6 col-sm-4 col-md-6 col-lg-2">
      <app-kpi-card
        [title]="'Total Biaya Usaha'"
        [value]="selectedMetrics()?.biaya_usaha ?? 0"
        info="Biaya Usaha Pada Bulan Terpilih"
        [subtitle]="compare ? '' : 'Break Even Point'"
        dataType="currency"
        icon="bi bi-cash-stack"
        iconColor="#228000"
        iconBgColor="#DCFFD0"
        [compareMode]="
          currentFilter.useCustomDate ? false : currentFilter.compare
        "
        [prevYearValue]="
          prevYearBlock()?.metrics?.biaya_usaha ??
          prevDateBlock()?.metrics?.biaya_usaha ??
          0
        "
        [prevYearSubtitle]="
          prevYearBlock()?.period ?? prevDateBlock()?.period ?? ''
        "
        [prevMonthValue]="prevMonthBlock()?.metrics?.biaya_usaha ?? 0"
        [prevMonthSubtitle]="prevMonthBlock()?.period ?? ''"
      />
    </div>

    <div class="col-6 col-sm-4 col-md-6 col-lg-2">
      <app-kpi-card
        [title]="'Total Revenue Ater Sales'"
        info="Total pendapatan after sales pada periode terpilih"
        [value]="selectedMetrics()?.total_revenue_realisasi ?? 0"
        [subtitle]="compare ? '' : 'Total Pendapatan After Sales'"
        icon="bi bi-cash"
        iconColor="#2563EB"
        dataType="currency"
        iconBgColor="#DBEAFE"
        [compareMode]="currentFilter.compare"
        [prevYearValue]="
          prevYearBlock()?.metrics?.total_revenue_realisasi ??
          prevDateBlock()?.metrics?.total_revenue_realisasi ??
          0
        "
        [prevYearSubtitle]="
          prevYearBlock()?.period ?? prevDateBlock()?.period ?? ''
        "
        [prevMonthValue]="
          prevMonthBlock()?.metrics?.total_revenue_realisasi ?? 0
        "
        [prevMonthSubtitle]="prevMonthBlock()?.period ?? ''"
      />
    </div>
    <!-- Total Profit -->
    <div class="col-6 col-sm-4 col-md-6 col-lg-2">
      <app-kpi-card
        [title]="'Total Profit Target'"
        info="Total profit yang ditargetkan pada periode terpilih"
        [value]="selectedMetrics()?.profit ?? 0"
        [subtitle]="compare ? '' : 'Target'"
        icon="bi bi-bullseye"
        dataType="currency"
        iconColor="#228000"
        iconBgColor="#DCFFD0"
        [compareMode]="currentFilter.compare"
        [prevYearValue]="
          prevYearBlock()?.metrics?.profit ??
          prevDateBlock()?.metrics?.profit ??
          0
        "
        [prevYearSubtitle]="
          prevYearBlock()?.period ?? prevDateBlock()?.period ?? ''
        "
        [prevMonthValue]="prevMonthBlock()?.metrics?.profit ?? 0"
        [prevMonthSubtitle]="prevMonthBlock()?.period ?? ''"
      />`
    </div>
    <!-- Total Profit Realisasi-->
    <div class="col-6 col-sm-4 col-md-6 col-lg-2">
      <app-kpi-card
        [title]="'Total Profit Realisasi'"
        info="Total profit realisasi pada periode terpilih.
        profit = (profit jasa service + (20% profit oli) + (17% profit part bengkel) + (17% profit part tunai) - biaya usaha)"
        [value]="selectedMetrics()?.profit_realisasi ?? 0"
        [subtitle]="compare ? '' : 'Target'"
        icon="bi bi-bullseye"
        dataType="currency"
        iconColor="#228000"
        iconBgColor="#DCFFD0"
        [compareMode]="currentFilter.compare"
        [prevYearValue]="
          prevYearBlock()?.metrics?.profit_realisasi ??
          prevDateBlock()?.metrics?.profit_realisasi ??
          0
        "
        [prevYearSubtitle]="
          prevYearBlock()?.period ?? prevDateBlock()?.period ?? ''
        "
        [prevMonthValue]="prevMonthBlock()?.metrics?.profit_realisasi ?? 0"
        [prevMonthSubtitle]="prevMonthBlock()?.period ?? ''"
      />`
    </div>
  </div>
  <div>
    <div class="row g-2">
      <div class="col-12 col-sm-6 col-md-4 col-lg-2">
          <app-kpi-card-as
            title="AFTER SALES"
            
            headerProgress="Realisasi vs Target"
            headerColor="#0070D2"
            [realisasi]="
              selectedMetrics()?.after_sales_plus_part_tunai_realisasi ?? 0
            "
            [target]="
              selectedMetrics()?.after_sales_plus_part_tunai_target ?? 0
            "
            [unitEntry]="getTotalUnitEntry()"
            [sisaHariKerja]="getSisaHariKerja()"
            [loading]="loading()"
            [isUnit]="false"
            [isHarapanTarget]="true"
            [compare]="currentFilter.compare || false"
            [prevMPeriod]="prevMonthBlock()?.period ?? ''"
            [prevYPeriod]="
              (prevYearBlock()?.period ?? prevDateBlock()?.period) || ''
            "
            [prevMRealisasi]="
              prevMonthBlock()?.metrics
                ?.after_sales_plus_part_tunai_realisasi ?? 0
            "
            [prevMTarget]="
              prevMonthBlock()?.metrics?.after_sales_plus_part_tunai_target ?? 0
            "
            [prevMDenomForAvg]="
              prevMonthBlock()?.metrics?.unit_entry_realisasi ?? 0
            "
            [prevYRealisasi]="
              prevYearBlock()?.metrics?.after_sales_plus_part_tunai_realisasi ??
              prevDateBlock()?.metrics?.after_sales_plus_part_tunai_realisasi ??
              0
            "
            [prevYTarget]="
              (prevYearBlock()?.metrics?.after_sales_plus_part_tunai_target ??
                prevDateBlock()?.metrics?.after_sales_plus_part_tunai_target) ||
              0
            "
            [prevYDenomForAvg]="
              prevYearBlock()?.metrics?.unit_entry_realisasi || 0
            "
          >
          </app-kpi-card-as>
        </div>
        <!-- Service Cabang -->
        <div class="col-12 col-sm-6 col-md-4 col-lg-2">
          <app-kpi-card-as
            [title]="'SERVICE CABANG'"
            headerProgress="Realisasi vs Target"
            headerColor="#3B00A0"
            [realisasi]="selectedMetrics()?.service_cabang_realisasi ?? 0"
            [target]="selectedMetrics()?.service_cabang_target ?? 0"
            [unitEntry]="getTotalUnitEntry()"
            [sisaHariKerja]="getSisaHariKerja()"
            [loading]="loading()"
            [isUnit]="false"
            [isHarapanTarget]="true"
            [compare]="currentFilter.compare || false"
            [prevMPeriod]="prevMonthBlock()?.period ?? ''"
            [prevYPeriod]="
              (prevYearBlock()?.period ?? prevDateBlock()?.period) || ''
            "
            [prevMRealisasi]="
              prevMonthBlock()?.metrics?.service_cabang_realisasi ?? 0
            "
            [prevMTarget]="
              prevMonthBlock()?.metrics?.service_cabang_target ?? 0
            "
            [prevMDenomForAvg]="
              prevMonthBlock()?.metrics?.unit_entry_realisasi ?? 0
            "
            [prevYRealisasi]="
              prevYearBlock()?.metrics?.service_cabang_realisasi ??
              prevDateBlock()?.metrics?.service_cabang_realisasi ??
              0
            "
            [prevYTarget]="
              (prevYearBlock()?.metrics?.service_cabang_target ??
                prevDateBlock()?.metrics?.service_cabang_target) || 0
            "
            [prevYDenomForAvg]="
              prevYearBlock()?.metrics?.unit_entry_realisasi || 0
            "
          >
          </app-kpi-card-as>
        </div>
        <!-- JASA SERVICE -->
        <div class="col-12 col-sm-6 col-md-4 col-lg-2">
          <app-kpi-card-as
            [title]="'JASA SERVICE'"
            headerProgress="Realisasi vs Target"
            headerColor="#3B00A0"
            [realisasi]="selectedMetrics()?.jasa_service_realisasi ?? 0"
            [target]="selectedMetrics()?.jasa_service_target ?? 0"
            [unitEntry]="getTotalUnitEntry()"
            [sisaHariKerja]="getSisaHariKerja()"
            [loading]="loading()"
            [isUnit]="false"
            [isHarapanTarget]="true"
            [compare]="currentFilter.compare || false"
            [prevMPeriod]="prevMonthBlock()?.period ?? ''"
            [prevYPeriod]="
              (prevYearBlock()?.period ?? prevDateBlock()?.period) || ''
            "
            [prevMRealisasi]="
              prevMonthBlock()?.metrics?.jasa_service_realisasi ?? 0
            "
            [prevMTarget]="prevMonthBlock()?.metrics?.jasa_service_target ?? 0"
            [prevMDenomForAvg]="
              prevMonthBlock()?.metrics?.unit_entry_realisasi ?? 0
            "
            [prevYRealisasi]="
              prevYearBlock()?.metrics?.jasa_service_realisasi ??
              prevDateBlock()?.metrics?.jasa_service_realisasi ??
              0
            "
            [prevYTarget]="
              (prevYearBlock()?.metrics?.jasa_service_target ??
                prevDateBlock()?.metrics?.jasa_service_target) || 0
            "
            [prevYDenomForAvg]="
              prevYearBlock()?.metrics?.unit_entry_realisasi || 0
            "
          >
          </app-kpi-card-as>
        </div>
        <!-- Unit Entry -->
        <div class="col-12 col-sm-6 col-md-4 col-lg-2">
          <app-kpi-card-as
            [title]="'Unit Entry'"
            headerProgress="Realisasi vs Target"
            headerColor="#588000"
            [realisasi]="selectedMetrics()?.unit_entry_realisasi ?? 0"
            [target]="selectedMetrics()?.unit_entry_target ?? 0"
            [unitEntry]="getTotalUnitEntry()"
            [sisaHariKerja]="getSisaHariKerja()"
            [loading]="loading()"
            [isUnit]="true"
            [isHarapanTarget]="true"
            [compare]="currentFilter.compare || false"
            [prevMPeriod]="prevMonthBlock()?.period ?? ''"
            [prevYPeriod]="
              (prevYearBlock()?.period ?? prevDateBlock()?.period) || ''
            "
            [prevMRealisasi]="
              prevMonthBlock()?.metrics?.unit_entry_realisasi ?? 0
            "
            [prevMTarget]="prevMonthBlock()?.metrics?.unit_entry_target ?? 0"
            [prevMDenomForAvg]="
              prevMonthBlock()?.metrics?.unit_entry_realisasi ?? 0
            "
            [prevYRealisasi]="
              prevYearBlock()?.metrics?.unit_entry_realisasi ??
              prevDateBlock()?.metrics?.unit_entry_realisasi ??
              0
            "
            [prevYTarget]="
              (prevYearBlock()?.metrics?.unit_entry_target ??
                prevDateBlock()?.metrics?.unit_entry_target) || 0
            "
            [prevYDenomForAvg]="
              prevYearBlock()?.metrics?.unit_entry_realisasi || 0
            "
          >
          </app-kpi-card-as>
        </div>
        <!-- PART TUNAI -->
        <div class="col-12 col-sm-6 col-md-4 col-lg-2">
          <app-kpi-card-as
            [title]="'SPAREPART TUNAI'"
            headerProgress="Realisasi vs Target"
            headerColor="#004B66"
            [realisasi]="selectedMetrics()?.part_tunai_realisasi ?? 0"
            [target]="selectedMetrics()?.part_tunai_target ?? 0"
            [unitEntry]="getTotalUnitEntry()"
            [sisaHariKerja]="getSisaHariKerja()"
            [loading]="loading()"
            [isUnit]="false"
            [isHarapanTarget]="true"
            [compare]="currentFilter.compare || false"
            [prevMPeriod]="prevMonthBlock()?.period ?? ''"
            [prevYPeriod]="
              (prevYearBlock()?.period ?? prevDateBlock()?.period) || ''
            "
            [prevMRealisasi]="
              prevMonthBlock()?.metrics?.part_tunai_realisasi ?? 0
            "
            [prevMTarget]="prevMonthBlock()?.metrics?.part_tunai_target ?? 0"
            [prevMDenomForAvg]="
              prevMonthBlock()?.metrics?.unit_entry_realisasi ?? 0
            "
            [prevYRealisasi]="
              prevYearBlock()?.metrics?.part_tunai_realisasi ??
              prevDateBlock()?.metrics?.part_tunai_realisasi ??
              0
            "
            [prevYTarget]="
              (prevYearBlock()?.metrics?.part_tunai_target ??
                prevDateBlock()?.metrics?.part_tunai_target) || 0
            "
            [prevYDenomForAvg]="
              prevYearBlock()?.metrics?.unit_entry_realisasi || 0
            "
          >
          </app-kpi-card-as>
        </div>
        <!-- PART BENGKEL -->
        <div class="col-12 col-sm-6 col-md-4 col-lg-2">
          <app-kpi-card-as
            [title]="'SPAREPART BENGKEL'"
            headerProgress="Realisasi vs Target"
            headerColor="#890000"
            [realisasi]="selectedMetrics()?.part_bengkel_realisasi ?? 0"
            [target]="selectedMetrics()?.part_bengkel_target ?? 0"
            [unitEntry]="getTotalUnitEntry()"
            [sisaHariKerja]="getSisaHariKerja()"
            [loading]="loading()"
            [isUnit]="false"
            [isHarapanTarget]="true"
            [compare]="currentFilter.compare || false"
            [prevMPeriod]="prevMonthBlock()?.period ?? ''"
            [prevYPeriod]="
              (prevYearBlock()?.period ?? prevDateBlock()?.period) || ''
            "
            [prevMRealisasi]="
              prevMonthBlock()?.metrics?.part_bengkel_realisasi ?? 0
            "
            [prevMTarget]="prevMonthBlock()?.metrics?.part_bengkel_target ?? 0"
            [prevMDenomForAvg]="
              prevMonthBlock()?.metrics?.unit_entry_realisasi ?? 0
            "
            [prevYRealisasi]="
              prevYearBlock()?.metrics?.part_bengkel_realisasi ??
              prevDateBlock()?.metrics?.part_bengkel_realisasi ??
              0
            "
            [prevYTarget]="
              (prevYearBlock()?.metrics?.part_bengkel_target ??
                prevDateBlock()?.metrics?.part_bengkel_target) || 0
            "
            [prevYDenomForAvg]="
              prevYearBlock()?.metrics?.unit_entry_realisasi || 0
            "
          >
          </app-kpi-card-as>
        </div>
        <!-- OLI -->
        <div class="col-12 col-sm-6 col-md-4 col-lg-2">
          <app-kpi-card-as
            [title]="'SPAREPART OLI'"
            headerProgress="Realisasi vs Target"
            headerColor="#944700"
            [realisasi]="selectedMetrics()?.ganti_oli_realisasi ?? 0"
            [target]="selectedMetrics()?.ganti_oli_target ?? 0"
            [unitEntry]="getTotalUnitEntry()"
            [sisaHariKerja]="getSisaHariKerja()"
            [loading]="loading()"
            [isUnit]="false"
            [isHarapanTarget]="true"
            [compare]="currentFilter.compare || false"
            [prevMPeriod]="prevMonthBlock()?.period ?? ''"
            [prevYPeriod]="
              (prevYearBlock()?.period ?? prevDateBlock()?.period) || ''
            "
            [prevMRealisasi]="
              prevMonthBlock()?.metrics?.part_bengkel_realisasi ?? 0
            "
            [prevMTarget]="prevMonthBlock()?.metrics?.part_bengkel_target ?? 0"
            [prevMDenomForAvg]="
              prevMonthBlock()?.metrics?.unit_entry_realisasi ?? 0
            "
            [prevYRealisasi]="
              prevYearBlock()?.metrics?.part_bengkel_realisasi ??
              prevDateBlock()?.metrics?.part_bengkel_realisasi ??
              0
            "
            [prevYTarget]="
              (prevYearBlock()?.metrics?.part_bengkel_target ??
                prevDateBlock()?.metrics?.part_bengkel_target) || 0
            "
            [prevYDenomForAvg]="
              prevYearBlock()?.metrics?.unit_entry_realisasi || 0
            "
          >
          </app-kpi-card-as>
        </div>
    </div>
  </div>
  } } @else {
  <!-- Empty State (no data) -->
  <div class="row">
    <div class="col-12">
      <div class="text-center py-5">
        @if (error()) {
        <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
        <h6 class="text-muted mb-0">{{ error() }}</h6>
        } @else {
        <i class="bi bi-bar-chart text-muted fs-1 mb-3"></i>
        <h6 class="text-muted mb-0">
          Belum ada data untuk ditampilkan. Silakan pilih filter dan klik cari.
        </h6>
        }
      </div>
    </div>
  </div>
  } }

  <!-- Spacer bawah -->
  <div style="height: 8px"></div>
</div>

<!-- ============ Global Loading Overlay ============ -->
<div class="global-loading-overlay" *ngIf="loading()">
  <div class="loader-box">
    <div class="spinner-with-logo mb-3" aria-label="Loading">
      <div
        class="spinner-border text-primary"
        role="status"
        aria-hidden="true"
      ></div>
      <img src="/favicon.ico" alt="Loading" class="spinner-logo" />
    </div>
    <div class="loading-text">{{ loadingMessage() }}</div>
  </div>
</div>
