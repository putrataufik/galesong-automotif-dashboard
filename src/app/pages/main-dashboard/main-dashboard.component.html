<div class="container-fluid p-4">
  <!-- Header dan Filter -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="fw-bold text-dark mb-3">
        Dashboard <span class="text-primary">Galesong Otomotif</span>
      </h2>

      <app-filter-main-dashboard [initialFilter]="prefilledFilter" [loading]="loading()" (search)="onSearch($event)" />
    </div>
  </div>

  <!-- Error Alert -->
  @if (error() && !loading()) {
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-danger border-0 rounded-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>Error:</strong> {{ error() }}
      </div>
    </div>
  </div>
  }

  <!-- Global Loading Spinner -->
  @if (loading()) {
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-center align-items-center p-5" style="min-height: 400px">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem" role="status">
          <span class="visually-hidden">Memuat dashboard...</span>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- SALES SECTION -->
  @if (prefilledFilter?.category === 'sales' || prefilledFilter?.category === 'all-category') {
  @if (hasData()) {

  <!-- Sales KPI Section -->
  <div class="row g-4 mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center mb-3">
        <i class="bi bi-speedometer2 text-primary me-2 fs-4"></i>
        <h4 class="mb-0 fw-bold text-dark">Sales Performance</h4>
      </div>
    </div>

    <!-- Total Unit Sales -->
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Total Unit Sales'" [value]="kpiTotalUnitSales() || 0" unit="unit"
        [subtitle]="'Akumulasi penjualan per tahun'" icon="icons/car.png" iconBgClass="bg-primary bg-opacity-10" />
    </div>

    <!-- Model Favorit -->
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Model Favorit'" [value]="kpiTopModel()?.name || '—'" [subtitle]="
            kpiTopModel()
              ? (kpiTopModel()!.unit || 0) + ' unit terjual'
              : 'Belum ada data'
          " icon="icons/wedding-car.png" iconBgClass="bg-warning bg-opacity-10" />
    </div>

    <!-- Cabang Penjualan Tertinggi -->
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Cabang Penjualan Tertinggi'" [value]="kpiTopBranch()?.code || '—'" [subtitle]="
            kpiTopBranch()
              ? (kpiTopBranch()!.unit || 0) + ' unit terjual'
              : 'Belum ada data'
          " icon="icons/winner.png" iconBgClass="bg-success bg-opacity-10" />
    </div>
  </div>

  <!-- Sales Charts Section -->
  @if (lineMonthly() || branchPerformance() || modelDistribution()) {
  <div class="row g-4 mb-5">
    <!-- Line Chart - Monthly Trend -->
    @if (lineMonthly()) {
    <div class="col-12 col-lg-6">
      <app-line-chart-card [label]="'Unit Terjual'" [title]="'Trend Penjualan Unit per Bulan'"
        [labels]="lineMonthly()!.labels" [data]="lineMonthly()!.data" [height]="300" [showLegend]="false"
        [borderColor]="'#0d6efd'" [backgroundColor]="'rgba(13, 110, 253, 0.2)'" [pointBackgroundColor]="'#0d6efd'"
        [fill]="true" />
    </div>
    }

    <!-- Bar Chart - Branch Performance -->
    @if (branchPerformance()) {
    <div class="col-12 col-lg-6">
      <app-bar-chart-card [title]="'Performa Penjualan per Cabang'" [labels]="branchPerformance()!.labels"
        [data]="branchPerformance()!.data" [height]="300" [horizontal]="true" [showLegend]="false"
        [label]="'Unit Terjual'" />
    </div>
    }

    <!-- Pie Chart - Model Distribution -->
    @if (modelDistribution()) {
    <div class="col-12 col-lg-3">
      <app-pie-chart-card [title]="'Proporsi Penjualan per Model Unit'" [labels]="modelDistribution()!.labels"
        [data]="modelDistribution()!.data" [height]="300" [showLegend]="true" />
    </div>
    }
  </div>
  }
  }
  }

  <!-- AFTER SALES SECTION -->
  @if (prefilledFilter?.category === 'after-sales' || prefilledFilter?.category === 'all-category') {
  @if (hasData()) {

  <!-- After Sales KPI Section -->
  @if (afterSalesKpi(); as kpi) {
  <div class="row g-4 mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center mb-3">
        <i class="bi bi-tools text-success me-2 fs-4"></i>
        <h4 class="mb-0 fw-bold text-dark">After Sales Performance</h4>
      </div>
    </div>


    <!-- Total Biaya Usaha (BEP) -->
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Total Biaya Usaha'" [value]="formatCompactNumber(kpi.totalBiayaUsaha)" unit=""
        [subtitle]="'Break Even Point'" icon="icons/money.png" iconBgClass="bg-warning bg-opacity-10" />
    </div>

    <!-- Total Profit -->
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Total Profit'" [value]="formatCompactNumber(kpi.totalProfit)" unit=""
        [subtitle]="'Keuntungan bersih'" icon="icons/uptrend.png" iconBgClass="bg-primary bg-opacity-10" />
    </div>

    <!-- Total Revenue After Sales -->
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Total Revenue After Sales'" [value]="formatCompactNumber(kpi.totalRevenueRealisasi)"
        [subtitle]="'Total pendapatan After Sales'" icon="icons/increase.png" iconBgClass="bg-success bg-opacity-10" />
    </div>


    <!-- Service Cabang -->
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Service Cabang'" [value]="formatCompactNumber(kpi.afterSalesRealisasi)" unit=""
        [subtitle]="'Total Service'" icon="icons/service-provider.png"
        iconBgClass="bg-purple bg-opacity-10" />
    </div>

    <!-- Unit Entry -->
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Unit Entry'" [value]="kpi.unitEntryRealisasi" unit="unit"
        [subtitle]="'Jumlah kendaraan masuk'" icon="icons/car-repair.png" iconBgClass="bg-success bg-opacity-10" />
    </div>

    <!-- Sparepart Tunai -->
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Sparepart Tunai'" [value]="formatCompactNumber(kpi.sparepartTunaiRealisasi)" unit=""
        [subtitle]="'Penjualan sparepart cash'" icon="icons/spare-parts.png" iconBgClass="bg-primary bg-opacity-10" />
    </div>
  </div>
  }

  <!-- After Sales Charts Section -->
  @if (afterSalesRealisasiVsTarget() || afterSalesProfitByBranch()) {
  <div class="row g-4 mb-5">
    <!-- After Sales Realisasi vs Target Chart -->
    @if (afterSalesRealisasiVsTarget()) {
    <div class="col-12 col-lg-6">
      <app-bar-chart-card [title]="'After Sales Realisasi vs Target per Bulan'"
        [chartData]="afterSalesRealisasiVsTarget()!" [height]="300" [horizontal]="false" [showLegend]="true"
        [isMultiDataset]="true" />
    </div>
    }

    <!-- Profit by Branch Chart -->
    @if (afterSalesProfitByBranch()) {
    <div class="col-12 col-lg-6">
      <app-bar-chart-card [title]="'Profit per Cabang (After Sales)'" [labels]="afterSalesProfitByBranch()!.labels"
        [data]="afterSalesProfitByBranch()!.data" [height]="300" [horizontal]="true" [showLegend]="false"
        [label]="'Profit'" [chartType]="'currency'" [backgroundColor]="'#ffc107'" [borderColor]="'#ffc107'" />
    </div>
    }
  </div>
  }
  }
  }

  <!-- Empty State -->
  @if (!hasData() && !loading()) {
  <div class="row">
    <div class="col-12">
      <div class="text-center py-5">
        @if (error()) {
        <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
        <h6 class="text-muted mb-0">{{ error() }}</h6>
        } @else {
        <i class="bi bi-bar-chart text-muted fs-1 mb-3"></i>
        <h6 class="text-muted mb-0">
          Belum ada data untuk ditampilkan. Silakan pilih filter dan klik cari.
        </h6>
        }
      </div>
    </div>
  </div>
  }
</div>