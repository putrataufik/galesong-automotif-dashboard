<div class="container-fluid p-4">
  <!-- Header dan Filter -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="fw-bold text-dark mb-3">
        After Sales <span class="text-success">Dashboard</span>
      </h2>
      <app-filter-aftersales-dashboard 
        [loading]="loading()" 
        (search)="onSearch($event)">
      </app-filter-aftersales-dashboard>
    </div>
  </div>

  <!-- Error Alert -->
  @if (error() && !loading()) {
    <div class="row mb-4">
      <div class="col-12">
        <div class="alert alert-danger border-0 rounded-3" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>Error:</strong> {{ error() }}
        </div>
      </div>
    </div>
  }

  <!-- Global Loading Spinner -->
  @if (loading()) {
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-center align-items-center p-5" style="min-height: 400px">
          <div class="spinner-border text-success" style="width: 3rem; height: 3rem" role="status">
            <span class="visually-hidden">Memuat dashboard after sales...</span>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- DEBUG INFO SECTION -->
  @if (hasData() && !loading()) {
    <div class="row mb-2">
      <div class="col-12">
        <div class="card border-warning border-2" style="background: #fff3cd;">
          <div class="card-body p-2">
            <small class="text-dark">
              <strong>üîç DEBUG INFO:</strong><br>
              showSisaHariKerja: <span class="badge bg-primary">{{ showSisaHariKerja() }}</span> | 
              sisaHariKerja: <span class="badge bg-info">"{{ sisaHariKerja }}"</span> | 
              options count: <span class="badge bg-success">{{ sisaHariKerjaOptions.length }}</span> |
              current filter month: <span class="badge bg-warning text-dark">"{{ currentFilter()?.month }}"</span>
            </small>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- KPI Cards Section -->
  @if (hasData() && !loading()) {
    <div class="row g-4 mb-4">
      <div class="col-12">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center">
            <i class="bi bi-speedometer2 text-success me-2 fs-4"></i>
            <h4 class="mb-0 fw-bold text-dark">After Sales Performance KPI</h4>
          </div>
          
          <!-- Sisa Hari Kerja Filter dengan debug info -->
          @if (showSisaHariKerja()) {
            <div class="d-flex align-items-center">
              <label for="sisaHariKerja" class="form-label small text-muted me-2 mb-0">
                Sisa Hari Kerja ({{ sisaHariKerjaOptions.length }} options):
              </label>
              <select
                id="sisaHariKerja"
                class="form-select form-select-sm"
                style="width: auto; min-width: 150px"
                [(ngModel)]="sisaHariKerja"
                (change)="onSisaHariKerjaChange()"
              >
                @for (sh of sisaHariKerjaOptions; track sh.value) {
                  <option [value]="sh.value">{{ sh.name }}</option>
                }
              </select>
            </div>
          } @else {
            <div class="text-muted small">
              <i class="bi bi-info-circle me-1"></i>
              Sisa hari kerja tersembunyi (showSisaHariKerja: {{ showSisaHariKerja() }})
            </div>
          }
        </div>
      </div>

      <!-- After Sales Realisasi vs Target -->
      <div class="col-12 col-md-6 col-xl-3">
        <app-kpi-card-as
          title="AFTER SALES REALISASI vs TARGET"
          headerColor="#2563EB"
          [realisasi]="kpiData()!.afterSales.realisasi"
          [target]="kpiData()!.afterSales.target"
          [unitEntry]="getTotalUnitEntry()"
          [sisaHariKerja]="getSisaHariKerja()"
          [loading]="loading()"
          [isUnit]="false">
        </app-kpi-card-as>
      </div>

      <!-- Service Cabang Realisasi vs Target -->
      <div class="col-12 col-md-6 col-xl-3">
        <app-kpi-card-as
          title="SERVICE CABANG REALISASI vs TARGET"
          headerColor="#3B00A0"
          [realisasi]="kpiData()!.serviceCabang.realisasi"
          [target]="kpiData()!.serviceCabang.target"
          [unitEntry]="getTotalUnitEntry()"
          [sisaHariKerja]="getSisaHariKerja()"
          [loading]="loading()"
          [isUnit]="false">
        </app-kpi-card-as>
      </div>

      <!-- Unit Entry Realisasi vs Target -->
      <div class="col-12 col-md-6 col-xl-3">
        <app-kpi-card-as
          title="UNIT ENTRY REALISASI vs TARGET"
          headerColor="#588000"
          [realisasi]="kpiData()!.unitEntry.realisasi"
          [target]="kpiData()!.unitEntry.target"
          [unitEntry]="getTotalUnitEntry()"
          [sisaHariKerja]="getSisaHariKerja()"
          [loading]="loading()"
          [isUnit]="true">
        </app-kpi-card-as>
      </div>

      <!-- Sparepart Tunai Realisasi vs Target -->
      <div class="col-12 col-md-6 col-xl-3">
        <app-kpi-card-as
          title="SPAREPART TUNAI REALISASI vs TARGET"
          headerColor="#944700  "
          [realisasi]="kpiData()!.sparepartTunai.realisasi"
          [target]="kpiData()!.sparepartTunai.target"
          [unitEntry]="getTotalUnitEntry()"
          [sisaHariKerja]="getSisaHariKerja()"
          [loading]="loading()"
          [isUnit]="false">
        </app-kpi-card-as>
      </div>
    </div>

    <!-- Additional Info Section -->
    <div class="row g-4">
      <div class="col-12">
        <div class="card border-0 shadow-sm rounded-3">
          <div class="card-body p-4">
            <h5 class="card-title fw-semibold text-dark mb-3">
              <i class="bi bi-info-circle-fill text-success me-2"></i>
              Informasi Dashboard
            </h5>
            <div class="row g-3">
              <div class="col-md-6">
                <h6 class="text-success fw-semibold mb-2">Metrics Explanation:</h6>
                <ul class="list-unstyled small">
                  <li class="mb-1">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    <strong>Grand Total:</strong> Selisih antara Realisasi dan Target
                  </li>
                  <li class="mb-1">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    <strong>Rata-rata:</strong> Realisasi dibagi Unit Entry Realisasi
                  </li>
                  <li class="mb-1">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    <strong>Harapan Target:</strong> Target dibagi Sisa Hari Kerja
                  </li>
                  <li class="mb-1">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    <strong>Service Cabang:</strong> After Sales minus Sparepart Tunai
                  </li>
                </ul>
              </div>
              <div class="col-md-6">
                <h6 class="text-success fw-semibold mb-2">Filter Information:</h6>
                @if (currentFilter(); as filter) {
                  <ul class="list-unstyled small">
                    <li class="mb-1">
                      <strong>Perusahaan:</strong> {{ filter.company }}
                    </li>
                    <li class="mb-1">
                      <strong>Cabang:</strong> {{ filter.cabang === 'all-cabang' ? 'Semua Cabang' : filter.cabang }}
                    </li>
                    <li class="mb-1">
                      <strong>Periode:</strong> {{ filter.period }}
                    </li>
                    <li class="mb-1">
                      <strong>Bulan:</strong> {{ filter.month === 'all-month' ? 'Semua Bulan' : filter.month }}
                    </li>
                    @if (sisaHariKerja) {
                      <li class="mb-1">
                        <strong>Sisa Hari Kerja:</strong> {{ sisaHariKerja }} hari
                      </li>
                    }
                  </ul>
                }
              </div>
            </div>

            <!-- Debug Section untuk Raw Data -->
            <div class="row g-3 mt-3">
              <div class="col-12">
                <h6 class="text-warning fw-semibold mb-2">
                  <i class="bi bi-bug me-1"></i>
                  Debug Data (Hapus di Production):
                </h6>
                <div class="bg-light p-2 rounded">
                  <small class="font-monospace">
                    KPI Data: {{ kpiData() | json }}
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Empty State -->
  @if (!hasData() && !loading() && !error()) {
    <div class="row">
      <div class="col-12">
        <div class="text-center py-5">
          <i class="bi bi-bar-chart text-muted fs-1 mb-3"></i>
          <h6 class="text-muted mb-0">
            Belum ada data untuk ditampilkan. Silakan pilih filter dan klik cari data.
          </h6>
          <p class="text-muted small mt-2">
            Pastikan memilih perusahaan dan periode yang valid
          </p>
        </div>
      </div>
    </div>
  }
</div>