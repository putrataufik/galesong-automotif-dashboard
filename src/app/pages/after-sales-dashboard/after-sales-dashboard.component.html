<div class="container-fluid p-4">
  <!-- Header dan Filter -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="fw-bold text-dark mb-3">
        After Sales <span class="text-success">Dashboard</span>
      </h2>
      <app-filter-aftersales-dashboard [loading]="loading()" [initialFilter]="currentFilter()"
        (search)="onSearch($event)">
      </app-filter-aftersales-dashboard>
    </div>
  </div>

  <!-- Error Alert -->
  @if (error() && !loading()) {
  <div class="row mb-4">
    <div class="col-12">
      <div class="alert alert-danger border-0 rounded-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>Error:</strong> {{ error() }}
      </div>
    </div>
  </div>
  }

  <!-- Global Loading Spinner -->
  @if (loading()) {
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-center align-items-center p-5" style="min-height: 400px">
        <div class="spinner-border text-success" style="width: 3rem; height: 3rem" role="status">
          <span class="visually-hidden">Memuat dashboard after sales...</span>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- ✅ SECTION 1: KPI Cards Tambahan -->
  @if (hasData() && !loading() && additionalKpiData()) {
  <div class="row g-4 mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center mb-3">
        <i class="bi bi-graph-up text-info me-2 fs-4"></i>
        <h4 class="mb-0 fw-bold text-dark">Summary Metrics</h4>
      </div>
    </div>

    <!-- Jumlah Mekanik - Hanya tampil jika pilih 1 bulan -->
    @if (showJumlahMekanik()) {
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Jumlah Mekanik'" [value]="additionalKpiData()!.jumlahMekanik" unit="orang"
        [subtitle]="'Total mekanik aktif'" icon="icons/service-provider.png" iconBgClass="bg-info bg-opacity-10" />
    </div>
    }

    <!-- Jumlah Hari Kerja - Jangan tampil jika semua cabang + semua bulan -->
    @if (showJumlahHariKerja()) {
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Jumlah Hari Kerja'" [value]="additionalKpiData()!.jumlahHariKerja" unit="hari"
        [subtitle]="'Total hari operasional'" icon="icons/leave.png" iconBgClass="bg-primary bg-opacity-10" />
    </div>
    }

    <!-- Total Biaya Usaha -->
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Total Biaya Usaha'" [value]="formatCompactNumber(additionalKpiData()!.totalBiayaUsaha)"
        [subtitle]="'Break Even Point (BEP)'" icon="icons/money.png" iconBgClass="bg-warning bg-opacity-10" />
    </div>

    <!-- Total Revenue -->
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Total Revenue'" [value]="formatCompactNumber(additionalKpiData()!.totalRevenueRealisasi)"
        [subtitle]="'Total Pendapatan Realisasi'" icon="icons/increase.png" iconBgClass="bg-success bg-opacity-10" />
    </div>

    <!-- Total Profit -->
    <div class="col-12 col-sm-6 col-md-6 col-xl-3">
      <app-kpi-card [title]="'Total Profit'" [value]="formatCompactNumber(additionalKpiData()!.totalProfit)"
        [subtitle]="'Keuntungan bersih'" icon="icons/uptrend.png" iconBgClass="bg-success bg-opacity-10" />
    </div>
  </div>
  }

  <!-- ✅ SECTION 2: Pencapaian Cabang (KPI Cards AS yang sudah ada) -->
  @if (hasData() && !loading()) {
  <div class="row g-4 mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center">
          <i class="bi bi-speedometer2 text-success me-2 fs-4"></i>
          <h4 class="mb-0 fw-bold text-dark">Pencapaian Cabang</h4>
        </div>

        <!-- Sisa Hari Kerja Filter dengan debug info -->
        @if (showSisaHariKerja()) {
        <div class="d-flex align-items-center">
          <label for="sisaHariKerja" class="form-label small text-muted me-2 mb-0">
          </label>
          <select id="sisaHariKerja" class="form-select form-select-sm" style="width: auto; min-width: 150px"
            [(ngModel)]="sisaHariKerja" (change)="onSisaHariKerjaChange()">
            @for (sh of sisaHariKerjaOptions; track sh.value) {
            <option [value]="sh.value">{{ sh.name }}</option>
            }
          </select>
        </div>
        }
      </div>
    </div>

    <!-- After Sales Realisasi vs Target -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="AFTER SALES REALISASI vs TARGET" headerColor="#2563EB"
        [realisasi]="kpiData()!.afterSales.realisasi" [target]="kpiData()!.afterSales.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>

    <!-- Service Cabang Realisasi vs Target -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="SERVICE CABANG REALISASI vs TARGET" headerColor="#3B00A0"
        [realisasi]="kpiData()!.serviceCabang.realisasi" [target]="kpiData()!.serviceCabang.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>

    <!-- Unit Entry Realisasi vs Target -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="UNIT ENTRY REALISASI vs TARGET" headerColor="#588000"
        [realisasi]="kpiData()!.unitEntry.realisasi" [target]="kpiData()!.unitEntry.target"
        [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="true">
      </app-kpi-card-as>
    </div>

    <!-- Sparepart Tunai Realisasi vs Target -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="SPAREPART TUNAI REALISASI vs TARGET" headerColor="#004B66"
        [realisasi]="kpiData()!.sparepartTunai.realisasi" [target]="kpiData()!.sparepartTunai.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>
    <!-- Sparepart Bengkel Realisasi vs Target -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="SPAREPART Bengkel REALISASI vs TARGET" headerColor="#890000"
        [realisasi]="kpiData()!.sparepartBengkel.realisasi" [target]="kpiData()!.sparepartBengkel.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>
    <!-- Sparepart Bengkel Realisasi vs Target -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="Oli REALISASI vs Total" headerColor="#944700" [realisasi]="kpiData()!.oli.realisasi"
        [target]="kpiData()!.oli.target" [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()"
        [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>
  </div>


  <!-- ========================================================== -->
  <!-- ✅ SECTION 3: Pencapaian SRO (KPI Cards AS yang sudah ada) -->
  <!-- ========================================================== -->
  <div class="row g-4 mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-start mb-3">
        <div class="d-flex align-items-center">
          <i class="bi bi-speedometer2 text-success me-2 fs-4"></i>
          <h4 class="mb-0 fw-bold text-dark">Pencapaian SRO</h4>
        </div>
      </div>
    </div>

    <!-- Jasa Service Berat vs Target -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="JASA SERVICE BERAT REALISASI vs TOTAL" headerColor="#2563EB"
        [realisasi]="kpiData()!.jasaServiceBerat.realisasi" [target]="kpiData()!.jasaServiceBerat.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>

    <!-- Jasa Service Body Repair Realisasi vs Target -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="JASA SERVICE BODY REPAIR REALISASI vs TOTAL" headerColor="#2563EB"
        [realisasi]="kpiData()!.jasaServiceBodyRepair.realisasi" [target]="kpiData()!.jasaServiceBodyRepair.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>

    <!-- Jasa Service CVT Realisasi vs Target -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="JASA SERVICE CVT REALISASI vs TOTAL" headerColor="#2563EB"
        [realisasi]="kpiData()!.jasaServiceCvt.realisasi" [target]="kpiData()!.jasaServiceCvt.target"
        [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="true">
      </app-kpi-card-as>
    </div>

    <!-- Jasa Service Express Realisasi vs Target -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="JASA SERVICE EXPRESS REALISASI vs TOTAL" headerColor="#2563EB"
        [realisasi]="kpiData()!.jasaServiceExpress.realisasi" [target]="kpiData()!.jasaServiceExpress.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>
    <!-- Jasa Service Kelistrikan  Realisasi vs Target -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="JASA SERVICE KELISTRIKAN REALISASI vs TOTAL" headerColor="#2563EB"
        [realisasi]="kpiData()!.jasaServiceKelistrikan.realisasi" [target]="kpiData()!.jasaServiceKelistrikan.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>
    <!-- Jasa Service oli Realisasi vs Target -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="JASA SERVICE OLI REALISASI vs TOTAL" headerColor="#2563EB"
        [realisasi]="kpiData()!.jasaServiceOli.realisasi" [target]="kpiData()!.jasaServiceOli.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>
    <!-- Jasa Service Over Size Realisasi vs TOTAL -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="JASA SERVICE OVER SIZE REALISASI vs TOTAL" headerColor="#2563EB"
        [realisasi]="kpiData()!.jasaServiceOverSize.realisasi" [target]="kpiData()!.jasaServiceOverSize.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>
    <!-- Jasa Service Overhoul Realisasi vs TOTAL -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="JASA SERVICE OVERHOUL REALISASI vs TOTAL" headerColor="#2563EB"
        [realisasi]="kpiData()!.jasaServiceOverhoul.realisasi" [target]="kpiData()!.jasaServiceOverhoul.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>
    <!-- Jasa Service Rutin Realisasi vs TOTAL -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="JASA SERVICE RUTIN vs TOTAL" headerColor="#2563EB"
        [realisasi]="kpiData()!.jasaServiceRutin.realisasi" [target]="kpiData()!.jasaServiceRutin.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>
    <!-- Jasa Service sedang Realisasi vs TOTAL -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="JASA SERVICE SEDANG vs TOTAL" headerColor="#2563EB"
        [realisasi]="kpiData()!.jasaServiceSedang.realisasi" [target]="kpiData()!.jasaServiceSedang.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>

    <h4>Non CPUS</h4>
    <!-- JASA SERVICE CLAIM Realisasi vs TOTAL -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="JASA SERVICE CLAIM REALISASI vs TOTAL" headerColor="#2563EB"
        [realisasi]="kpiData()!.jasaServiceClaim.realisasi" [target]="kpiData()!.jasaServiceClaim.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>
    <!-- JASA SERVICE KUPON Realisasi vs TOTAL -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="JASA SERVICE KUPON REALISASI VS TOTAL" headerColor="#2563EB"
        [realisasi]="kpiData()!.jasaServiceKupon.realisasi" [target]="kpiData()!.jasaServiceKupon.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>
    <!-- JASA SERVICE PDC Realisasi vs TOTAL -->
    <div class="col-12 col-md-6 col-xl-3">
      <app-kpi-card-as title="JASA SERVICE PDC REALISASI vs TOTAL" headerColor="#2563EB"
        [realisasi]="kpiData()!.jasaServicePdc.realisasi" [target]="kpiData()!.jasaServicePdc.target"
        [unitEntry]="getTotalUnitEntry()" [sisaHariKerja]="getSisaHariKerja()" [loading]="loading()" [isUnit]="false">
      </app-kpi-card-as>
    </div>
  </div>
  }

  <!-- Empty State -->
  @if (!hasData() && !loading() && !error()) {
  <div class="row">
    <div class="col-12">
      <div class="text-center py-5">
        <i class="bi bi-bar-chart text-muted fs-1 mb-3"></i>
        <h6 class="text-muted mb-0">
          Belum ada data untuk ditampilkan. Silakan pilih filter dan klik cari data.
        </h6>
        <p class="text-muted small mt-2">
          Pastikan memilih perusahaan dan periode yang valid
        </p>
      </div>
    </div>
  </div>
  }
</div>